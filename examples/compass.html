<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	<title>FULLTILT compass demo</title>
	<style>

		* {
			padding: 0;
			margin: 0;
		}
	</style>
	<link rel="stylesheet" href="./resources/css/header.css">

</head>
<body>

	<div id="buttons">
		<button type="button" id="startButton" class="my-button">Start</button>
	</div>

	<canvas id="arrow"></canvas>

	<script type="module">
		import {getDeviceOrientation} from "../dist/fulltilt.min.js";

		let arrowSize = window.innerWidth < window.innerHeight ? window.innerWidth : window.innerHeight;
		let halfArrowWidth = arrowSize / 2;

		const arrow = document.getElementById('arrow');
		const ctx = arrow.getContext('2d');

		// Set initial canvas width/height
		arrow.width = arrowSize;
		arrow.height = arrowSize;

		const startButton = document.querySelector('#startButton');
		let orientationControl;

		const start = async () => {
			if (!orientationControl) {
				orientationControl = await getDeviceOrientation({'type': 'world'});
			}
			startButton.innerText = 'Stop';
			startButton.removeEventListener('click', start);
			startButton.addEventListener('click', stop, false);

			orientationControl.listen(function () {

				// Get latest screen-adjusted deviceorientation data
				const screenAdjustedEuler = orientationControl.getScreenAdjustedEuler();

				ctx.clearRect(0, 0, arrowSize, arrowSize);

				// Convert true north heading to radians
				const heading = screenAdjustedEuler.alpha * Math.PI / 180;

				const x1 = halfArrowWidth + Math.round(halfArrowWidth * Math.sin(heading));
				const y1 = halfArrowWidth - Math.round(halfArrowWidth * Math.cos(heading));
				const x2 = halfArrowWidth + Math.round(10.0 * Math.sin(heading - Math.PI / 2));
				const y2 = halfArrowWidth - Math.round(10.0 * Math.cos(heading - Math.PI / 2));
				const x3 = halfArrowWidth + Math.round(10.0 * Math.sin(heading + Math.PI / 2));
				const y3 = halfArrowWidth - Math.round(10.0 * Math.cos(heading + Math.PI / 2));

				ctx.beginPath();
				ctx.moveTo(x1, y1);
				ctx.lineTo(x2, y2);
				ctx.lineTo(x3, y3);
				ctx.closePath();
				ctx.fill();
			});
		}

		const stop = async () => {
			orientationControl?.stop();
			startButton.innerText = 'Start';
			startButton.removeEventListener('click', stop);
			startButton.addEventListener('click', start, false);
		}

		startButton.addEventListener('click', start, false);

		window.addEventListener('resize', function () {
			arrowSize = window.innerWidth < window.innerHeight ? window.innerWidth : window.innerHeight

			halfArrowWidth = arrowSize / 2;

			arrow.width = arrowSize;
			arrow.height = arrowSize;

		}, false);

	</script>
</body>
</html>
